<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"></script>
    <script src="./src/connect.js"></script>
    <script src="./src/show.js"></script>
    <link rel="icon" href="data:,">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Show Drugs</title>
</head>
<body>
    <div>
        <h2>All Drugs with Update Button</h2>
        <button onclick="getAllDrugsWithUpdate()">Get All Drugs with Update Button</button>
        <ul id="allDrugsWithUpdateList"></ul>
    </div>

    <div>
        <h2>Drug by ID</h2>
        <label for="drugId">Enter Drug ID:</label>
        <input type="number" id="drugId" name="drugId" required>
        <button onclick="getDrugById()">Get Drug by ID</button>
        <div id="singleDrugInfoContainer"></div>
    </div>

    <div>
        <h2>Delete Drug by ID</h2>
        <label for="drugIdToDelete">Enter Drug ID to Delete:</label>
        <input type="number" id="drugIdToDelete" name="drugIdToDelete" required>
        <button onclick="deleteDrugById()">Delete Drug by ID</button>
    </div>
  
    <script>
        async function getDrugById() {
        const drugId = document.getElementById('drugId').value;
        try {
            // Gọi hàm getDrug từ smart contract và hiển thị thông tin drug
            const drug = await window.contract.methods.getDrug(drugId).call({ from: window.ethereum.selectedAddress });
            displaySingleDrug("singleDrugInfoContainer", drug);
        } catch (error) {
            console.error('Error getting drug by ID:', error);
        }
    }

        function displaySingleDrug(elementId, drug) {
            const container = document.getElementById(elementId);
            container.innerHTML = "";

            const drugInfo = document.createElement("p");
            drugInfo.textContent = JSON.stringify(drug);
            container.appendChild(drugInfo);

            // Thêm button "Update Drug"
            const updateButton = document.createElement("button");
            updateButton.textContent = "Update Drug";
            updateButton.onclick = function () {
                redirectToUpdateDrug(drug);
            };
            container.appendChild(updateButton);
        }

        async function getAllDrugsWithUpdate() {
            try {
                const allDrugs = await window.contract.methods.getAllDrugs().call({ from: window.ethereum.selectedAddress });
                displayDrugsWithUpdate("allDrugsWithUpdateList", allDrugs);
            } catch (error) {
                console.error('Error getting all drugs with update button:', error);
            }
        }

        // Ensure that connectContract is called before loading drugs
        window.addEventListener('DOMContentLoaded', async (event) => {
            await connectContract();
            await getAllDrugsWithUpdate(); // Automatically load all drugs with update button
        });

        function redirectToUpdateDrug(drug) {
        // Pass the necessary information to updateDrug.html using query parameters
        const queryParams = `?id=${drug.id}&name=${encodeURIComponent(drug.name)}&classification=${encodeURIComponent(drug.classification)}&expirationDate=${encodeURIComponent(drug.expirationDate)}&productionDate=${encodeURIComponent(drug.productionDate)}&quantity=${encodeURIComponent(drug.quantity)}&location=${encodeURIComponent(drug.location)}&batchNumber=${encodeURIComponent(drug.batchNumber)}&ingredients=${encodeURIComponent(drug.ingredients)}&status=${drug.status}`;

        window.location.href = `updateDrug.html${queryParams}`;
        }
  

        function addUpdateButton(drug) {
            const updateButton = document.createElement("button");
            updateButton.textContent = "Update";
            updateButton.onclick = function () {
                redirectToUpdateDrug(drug);
            };

            const listItem = document.createElement("li");
            listItem.textContent = JSON.stringify(drug);
            listItem.appendChild(updateButton);

            document.getElementById("allDrugsWithUpdateList").appendChild(listItem);
        }

       
    </script>
</body>
</html>
